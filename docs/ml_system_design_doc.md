# ML System Design Doc 

# 1. Цели и предпосылки

## 1.1. Зачем идем в разработку продукта?
### Бизнес-цель: 
Разработать сервис для первичного анализа состояния кожи, с использованием ИИ. Приложение направлено на то, чтобы помочь пользователям лучше понять состояние своей кожи, предоставляя персонализированный анализ кожи с подсвечиванием проблемных зон на загруженных фотографиях лица 
### Почему станет лучше, чем сейчас, от использования ML: 
В настоящее время пользователи часто полагаются на общие советы по уходу за кожей, которые могут быть не оптимальными для их индивидуальных потребностей. Используя методы машинного обучения, приложение поможет пользователям быстро и незатруднительно получить более точный и персонализированный анализ состояния кожи, выявляя проблемы, например, угри, покраснение и неровный тон кожи. Это позволит пользователю понять проблемы и потребности собственной кожи и персонализировать уход
### Что будем считать успехом итерации с точки зрения бизнеса: 
- Точное определение дефектов кожи на загруженном изображении - измеряемое путем проверки на соответствие оценкам дерматологов.
- Вовлеченность и удовлетворенность пользователей - обратная связь, отзывы и тд.

## 1.2. Бизнес-требования и ограничения

### Краткое описание БТ и ссылки на детальные документы с бизнес-требованиями:
 - Загрузка изображения лица пользователем, 
 - Обработка изображения с использованием ML-моделей, 
 - Увеличение контрастности проблемных зон, 
 - Выделение областей с кожными проблемами (акне, покраснения, неровный тон), 
 - Возврат размеченных изображений пользователю
 -  Обеспечение высокой точности и надежности анализа состояния кожи

### Бизнес-ограничения:
- Строгие требования к защите данных и конфиденциальности
- Поддержка основных форматов изображений (JPEG, PNG)
- Масштабируемость системы
- Быстрая обработка изображений (не более 3-5 секунд)
- Жесткие сроки для запуска начальной версии приложения из-за конкурентного давления (январь 2025-го)

### Что мы ожидаем от конкретной итерации:
- Разработка функционального прототипа, который сможет точно обнаруживать и выделять основные проблемы кожи на загруженных фотографиях
- Проверка точности и полезности приложения с помощью тестирования пользователями и сбора обратной связи
- Заложить техническую основу для будущих итераций.

### Описание бизнес-процесса пилота, насколько это возможно:
1. Пользователь загружает фотографию лица в приложение
2. Приложение анализирует фотографию и определяет любые проблемы или подозрения на проблемы с кожей
3. Пользователи предоставляют отзывы о точности анализа и полезности рекомендаций
4. Команда приложения собирает и анализирует отзывы пользователей, чтобы улучшить модель и рекомендации для будущих версий

### Что считаем успешным пилотом? Критерии успеха и возможные пути развития проекта:
- Доля положительных отзывов пользователей > 80%
- Точность детекции > 80%
- Время обработки < 5 секунд
- Удобство использования (SUS > 75 %)
- Стабильность работы системы (Uptime > 90 %)

###  Возможные пути развития проекта: 
- Улучшить возможности анализа кожи для обнаружения более широкого спектра проблем
- Создать систему рекомендаций по уходу за кожей для обеспечения более персонализированных и динамических советов
- Изучить возможность интеграции с платформами - каталогами продуктов для ухода за кожей
- Изучить возможность интеграции с сервисами, предоставляющими дистанционные консультации с врачами-дерматологами и т.п.
- Разработать мобильные приложения и другие формы для улучшения пользовательского опыта

## 1.3. Что входит в скоуп проекта/итерации, что не входит

### На закрытие каких БТ подписываемся в данной итерации: 
- Разработка MVP с детекцией акне и кожных дефектов по фото
- Многомодельное решение (YOLO, CLIP) 
- Обеспечение интуитивно понятного пользовательского интерфейса для загрузки фотографий и просмотра результатов анализа

### Что не будет закрыто (в данной итерации): 
- Возможность отслеживать улучшение состояния кожи со временем
- Разработка мобильного приложения
- Полноценная медицинская диагностика
- Рекомендации по уходу 

### Описание результата с точки зрения качества кода и воспроизводимости решения: 
- Модульная и масштабируемая архитектура
- Comprehensive automated testing suite to ensure reliability and regression testing
- Четкая документация и шаблоны проектирования (для облегчения дальнейшей разработки и адаптации новых членов команды)
- Deployment pipeline, поддержка CI/CD

### Описание планируемого технического долга (что оставляем для дальнейшей продуктивизации): 
- Расширенная аналитика и рекомендации по уходу
- Расширенный набор возможностей по обнаружению состояния кожи

## 1.4. Предпосылки решения

### Описание всех общих предпосылок решения, используемых в системе – с обоснованием от запроса бизнеса: какие блоки данных используем, горизонт прогноза, гранулярность модели, и др.

- Рост интереса к персонализированным медицинским решениям
- Развитие технологий компьютерного зрения
- Доступность ML-библиотек для детекции объектов

Какие блоки данных:
- Мы будем использовать набор данных фотографий лиц, помеченных различными состояниями и проблемами кожи, полученных из авторитетных дерматологических источников.

Горизонт прогноза:
- Анализ состояния кожи, предоставляемые приложением, будут основываться на текущем состоянии кожи пользователя по одной фотографии, без долгосрочного прогнозирования

- Целевая точность моделей обнаружения состояния кожи - достижение не менее 90% точности и полноты, подтвержденных оценками дерматологов.

# 2. Методология

## 2.1. Постановка задачи

1. Анализ изображений:
   - Внедрение моделей компьютерного зрения для обнаружения и локализации различных состояний кожи (например, акне, покраснение, неровный тон кожи) на загруженных изображениях лица.
   - Использование таких методов, как сверточные нейронные сети и алгоритмы сегментации, для достижения точного обнаружения на уровне пикселей.
2. Пользовательский интерфейс:
   - Разработка интуитивно понятного пользовательского интерфейса, который позволяет пользователям легко загружать фотографии, просматривать результаты анализа кожи и получать доступ к рекомендуемым продуктам.
   - Включение визуально привлекательных визуализаций для выделения обнаруженных проблем с кожей и предоставления четких указаний по рекомендуемым действиям.
3. Внутренняя инфраструктура:
   - Создание масштабируемой внутренней системы для обработки запросов пользователей, обработки изображений и обслуживания результатов анализа кожи и рекомендаций.

## 2.2 Блок-схема решения


![](block-schema.png)

## 2.3 Этапы решения задачи

### Этап 1. Подготовка данных

1. Описание данных/сущностей

[EDA](eda.md)

- Набор изображения лиц пользователей с различными состояниями кожи, размеченные дерматологами. Формат: JPEG/PNG изображения
- Метаданные изображений (разрешение, условия съемки)

| Название        | Есть ли данные в компании | Требуемый ресурс        | Проверено ли качество данных |
|-----------------|--------------------------|-------------------------|------------------------------|
| Фотографии кожи | Частично                 | DE/DS                   | -                            |
| Аннотации к дефектам кожи | Частично, DATAMARTS_SKIN_ANNOTATIONS |                         | -                            |
| img metadata     | DATAMARTS_IMAGE_METADATA | DE                      | +                            |

Целевая переменная - изображение со следующими переменными: img_id, label, defect_coords, severity_score

Признаки: img_id, metadata, img_path, features

Выявленные проблемы и риски:

- Отсутствие готового размеченного датасета / Малое количество датасетов
- Необходимость сбора дополнительных данных, привлечения экспертов-дерматологов для разметки
- Разнообразие качества изображений
- Несбалансированность в представлении различных типов кожных проблем, типов кожи
- Возможное наличие нерелевантных данных (ошибочные аннотации, низкое качество)
- Недостаток данных для обучения моделей (особенно редких типов дефектов)
- Наличие конфиденциальной информации (лицевые изображения требуют строгой защиты)


2. Описание процесса генерации данных

- Сбор изображений: закупка существующих медицинских датасетов, партнерство с дерматологами, краудсорсинг
- Дополнение набора данных через аугментацию (обрезка, изменение яркости, поворот)
- Разметка неразмеенных данных: привлечение сертифицированных дерматологов, создание инструкции по разметке
- Удаление конфиденциальной информации

Методы борьбы с дисбалансом классов:
 - Использование Weighted Cross-Entropy Loss с весами, обратно пропорциональными частоте классов. Это позволит придать большее значение редким классам при обучении.
 - Применение Focal Loss, который автоматически уделяет больше внимания сложным для классификации примерам и уменьшает влияние легких примеров (часто это примеры доминирующего класса).
 - Внедрение Weighted Random Sampling при формировании батчей, где вероятность выбора примера обратно пропорциональна частоте его класса
Использование Balanced Batch Sampler для создания батчей с равным представлением всех классов
 - Применение стратегии Over-sampling для миноритарных классов внутри батча
 - Отслеживание метрик F1-score и Balanced Accuracy вместо обычной accuracy для более объективной оценки качества модели на несбалансированных данных
 - Мониторинг per-class accuracy для контроля качества предсказаний для каждого класса

3. Конфиденциальная информация
   Все персональные данные должны быть деидентифицированы: удаление конфиденциальной информации путем размытия или обрезки
   Необходимо получение согласия на использование фотографий. Хранение данных с соблюдением норм

4. Необходимый результат этапа
   Чистый, аугментированный набор данных с высокой репрезентативностью и качеством

### Этап 2. Подготовка прогнозных моделей

ML-метрики и функции потерь:

mIoU (Mean Intersection over Union) для сегментации.
Precision/Recall для классификации дефектов.
Accuracy для базовых тестов.

Cross-Entropy для классификации.
Dice Loss для сегментации.

Схема валидации: Кросс-валидация (K-fold) с разделением данных на тренировочную, валидационную и тестовую выборки. Учет данных с разных типов кожи, возрастных групп и освещения для репрезентативности.

Структура бейзлайна:
Использование YOLO для локализации проблемных зон.
Предварительная классификация дефектов кожи через ResNet50.

MVP:
Интеграция YOLOv8 для сегментации и детекции дефектов.
Тонкая настройка модели под разметку данных.

Риски:
Несоответствие метрик ожиданиям (низкий recall).
Долгое время инференса при больших изображениях.

Необходимый результат:
Модель, демонстрирующая точность >80% на тестовом наборе.
Временной отклик не более 3 секунд на изображение.

### Этап 3. Интерпретация моделей (согласование с бизнесом)

Данные:

- Результаты прогнозов модели на тестовых данных: изображения с выделенными проблемными зонами и их классификацией.

Риски:

- Непонимание бизнесом технических аспектов модели.
- Ожидания более высокой точности, чем реально возможно на текущем этапе.

Решение:

- Сравнение прогнозов модели с эталонной разметкой от дерматологов для выявления случаев ошибок и анализа уверенности предсказаний
- Визуализация прогнозов для представления результатов бизнесу.
- Обзор примеров с высокой/низкой точностью, чтобы показать сильные и слабые стороны модели.

Необходимый результат:

- Метрики уверенности по каждому предсказанию
- Документ, фиксирующий согласованные цели по метрикам
- Одобрение бизнесом текущего уровня точности для перехода к следующим этапам.

### Этап 4. Интеграция бизнес-правил для расчета метрик качества модели

Данные:

- Предсказания модели на тестовых и бизнес-специфичных данных.
- Дополнительные бизнес-правила (Выделение только наиболее значимых зон и т.п.).

Риски:

- Конфликт между бизнес-правилами и оптимизацией модели (Сокращение ложных срабатываний снижает recall)

Решение:

- Разработка скриптов для автоматического расчета бизнес-метрик (Доля ошибок, связанных с ложными срабатываниями на "здоровой" коже и тп.).
- Внедрение логики фильтрации прогнозов модели на основе бизнес-правил (Минимальный размер дефекта для выделения).

Необходимый результат:

- Система расчета бизнес-метрик.
- Согласованные пороговые значения для перехода на следующие этапы.

### Этап 5. Подготовка инференса модели

Данные:

- Входные изображения пользователей и тестовые данные.
- Предсказания модели.

Решение:

- Оптимизация модели для инференса
- Реализация инференс-скриптов с учетом требований производительности
- Интеграция с базовым пользовательским интерфейсом, включение в интерфейс простых инструментов для оценки пользователями точности модели
- Тестирование инференса

Риски:

- Падение точности при оптимизации модели

Необходимый результат:

- Полное покрытие тестами
- Интеграция оптимизированной модели в рабочий процесс
- Мониторинга производительности инференса

### Этап 6: Подготовка финального отчета для бизнеса

Данные:

- Результаты работы модели
- Отзывы пользователей, собранные в процессе пилотного тестирования

Задачи:

- Подготовка визуально привлекательного отчета с ключевыми метриками, графиками и примерами
- Включение результатов проверки метрик качества, указание на зоны для улучшения

Риски:

- Сложность интерпретации технических деталей бизнесом.

Необходимый результат:

- Полный отчет с интерпретацией результатов работы модели.
- Рекомендации по следующим итерациям.

